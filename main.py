import pandas as pd
from sklearn.metrics import classification_report
from sklearn.metrics import confusion_matrix
from sklearn.metrics import accuracy_score
from sklearn.svm import SVC
from sklearn.neighbors import KNeighborsClassifier
from sklearn.tree import ExtraTreeClassifier, DecisionTreeClassifier
from sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier, AdaBoostClassifier
from sklearn.feature_selection import SelectFromModel
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import OneHotEncoder

columns = ['ID', 'MD5', 'Feauters']

worm_feauters = ['Potentially Bad Traffic', 'C2 URLs / IPs found in malware configuration',
                 'Uses dynamic DNS services', 'Domain Observed Used for C2 Detected',
                 'Creates processes via WMI']
virus_feauters = ['Detects the creation of an executable by another executable',
                  'Uses schtasks.exe or at.exe to add and modify task schedules',
                  'Query firmware table information (likely to detect VMs)',
                  'Contains functionality to spread to USB devices (.Net source)',
                  'Contains functionality to log keystrokes (.Net Source)',
                  'Uses cmd line tools excessively to alter registry or file data']
trojan_feauters = ['A Network Trojan was detected',
                   'Tries to harvest and steal browser information (history, passwords, etc)',
                   'Tries to steal Crypto Currency Wallets',
                   'Found many strings related to Crypto-Wallets (likely being stolen)',
                   'Modifies user documents (likely ransomware behavior)',
                   'Tries to harvest and steal ftp login credentials',
                   'Overwrites code with unconditional jumps - possibly settings hooks in foreign process']
unknown_feauters = ['Binary contains a suspicious time stamp']

data = pd.read_csv('new_base.csv', sep='|')
data.drop('MD5', axis=1, inplace=True)
#data.drop('ID', axis=1, inplace=True)

#print(data.head(50))

X = data.iloc[:,:-1].values
y = data['Type']

#X = LabelEncoder().fit_transform(X)
X = OneHotEncoder().fit_transform(X)

fsel = ExtraTreeClassifier().fit(X, y)
model = SelectFromModel(fsel, prefit=True)
X_new = model.transform(X)
nb_feauters = X_new.shape[1]


X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2)

algorithms = {
    "DecisionTree" : DecisionTreeClassifier(max_depth=10),
    "RandomForest" : RandomForestClassifier(n_estimators=50),
    "GradientBoosting" : GradientBoostingClassifier(n_estimators=50),
    "AdaBoost" : AdaBoostClassifier(n_estimators=50),
    "KNeighbors" : KNeighborsClassifier(n_neighbors=5),
}

results = {}
print('\nNow testing algorithms')
for algo in algorithms:
    clf = algorithms[algo]
    clf.fit(X_train, y_train)
    score = clf.score(X_test, y_test)
    print(f'{algo} : {score * 100}')
    results[algo] = score

#winner = max(results, key=results.get)
winner = {}
winner['GradientBoosting'] = algorithms['GradientBoosting']

#print(X_train)
#print(y_train)

"""

SVC_model = SVC()
KNN_model = KNeighborsClassifier(n_neighbors=5)

#SVC_model = SVC()
#KNN_model = ExtraTreeClassifier()

SVC_model.fit(X_train, y_train)
KNN_model.fit(X_train, y_train)

SVC_prediction = SVC_model.predict(X_test)
KNN_prediction = KNN_model.predict(X_test)

print(accuracy_score(SVC_prediction, y_test))
print(accuracy_score(KNN_prediction, y_test))

print(confusion_matrix(SVC_prediction, y_test))
print(classification_report(KNN_prediction, y_test))

"""